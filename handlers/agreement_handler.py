from aiogram import Router, F
from aiogram.types import CallbackQuery
from aiogram.exceptions import TelegramBadRequest
from google_sheets.google_sheets_class import GoogleSheetClass
from aiogram.fsm.context import FSMContext

from handlers.keyboards.get_subscription_check_keyboard import get_subscription_check_keyboard
from handlers.keyboards.get_agreement_keyboard import get_agreement_keyboard

from handlers.questions_handlers.question_flow_handler import start_buyer_flow

from handlers.states.user_flow import UserFlow
router = Router()

@router.callback_query(F.data.startswith("agree_"))
async def handle_agreement(
    callback: CallbackQuery,
    state: FSMContext,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str,
    CHANNEL_USERNAME: str,
):
    username = callback.from_user.username or "–±–µ–∑ username"
    telegram_id = callback.from_user.id
    value = "–î–∞" if callback.data == "agree_yes" else "–ù–µ—Ç"

    spreadsheet.update_buyer_button_status(
        sheet_name=BUYERS_SHEET_NAME,
        telegram_id=telegram_id,
        button_name="agree",
        value=value
    )

    if callback.data == "agree_yes":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
        try:
            member = await callback.message.bot.get_chat_member(
                chat_id=CHANNEL_USERNAME,
                user_id=callback.from_user.id
            )
            if member.status in ("member", "administrator", "creator"):
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∞–Ω ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                await callback.message.answer(
                    "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª.",
                )

                # –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Ç–∞–±–ª–∏—Ü–µ
                spreadsheet.update_buyer_button_status(
                    sheet_name=BUYERS_SHEET_NAME, 
                    telegram_id=telegram_id, 
                    button_name="subscribe", 
                    value="–î–∞"
                )
                # üëâ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
                await start_buyer_flow(callback.message, spreadsheet, BUYERS_SHEET_NAME, state)
            else:
                # –ù–µ –ø–æ–¥–ø–∏—Å–∞–Ω
                await callback.message.answer(
                    "‚ùå –ü–æ–∫–∞ –≤—ã –Ω–µ –ø–æ–¥–ø–∏—à–µ—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª ‚Äî —Ä–∞–∑–¥–∞—á–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.\n"
                    f"–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ {CHANNEL_USERNAME} –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:",
                    reply_markup=get_subscription_check_keyboard()
                )
        except TelegramBadRequest:
            await callback.message.answer(
                "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–∞–Ω–∞–ª–∞."
            )
    else:
        await callback.message.answer(
            "‚ùå –ë–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è —É—á–∞—Å—Ç–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. –í—ã —Å–æ–≥–ª–∞—Å–Ω—ã –Ω–∞ —É—Å–ª–æ–≤–∏—è?",
            reply_markup=get_agreement_keyboard()
        )
        await state.set_state(UserFlow.waiting_for_agreement)

    await callback.answer()