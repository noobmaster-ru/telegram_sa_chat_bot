from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext

from database import user_exists, add_user
import logging
import re

from generators import create_response
from google_sheets_class import GoogleSheetClass
from handlers.keyboards import get_three_buttons_keyboard, get_different_number_of_buttons_keyboard

router = Router()

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[
        logging.FileHandler("data/bot.log", encoding="utf-8"),  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
        logging.StreamHandler(),  # –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
    ],
)

ADMIN_ID_LIST = [694144143, 547299317]

# —Å–ø–∏—Å–æ–∫ "–¥–æ–±—Ä—ã—Ö" —Å–ª–æ–≤
OK_WORDS = {"–æ–∫", "ok", "—Ö–æ—Ä–æ—à–æ", "–ª–∞–¥–Ω–æ", "–æ–∫–µ–π", "–¥–∞", "–æ–∫.", "–æ–∫!", "–æ–∫–µ–π!", "—Ö–æ—Ä–æ—à–æ,—Å–µ–π—á–∞—Å", "–ø–æ–Ω—è–ª"}


@router.message(StateFilter("generating"))
async def wait_response(message: Message):
    await message.answer("–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ ...")

# –∑–¥–µ—Å—å –Ω–∞–¥–æ –±—ã–ª–æ business_message —É–∫–∞–∑–∞—Ç—å!!!!!
@router.business_message()
async def handle_message(
    message: Message, 
    state: FSMContext, 
    instruction_str: str,
    LOWER_LIMIT_OF_MESSAGE_LENGTH: int,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str,
    nm_id: str
):
    user_id = message.from_user.id
    username = message.from_user.username or "–±–µ–∑ username"
    full_name = message.from_user.full_name or "–±–µ–∑ full_name"
    text = message.text if message.text else "(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)"

    # —Ç–µ—Å—Ç - –æ—Ç–≤–µ—á–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —è –∏ —Ç–µ–º–∞
    if user_id in ADMIN_ID_LIST and not user_exists(user_id):
        add_user(user_id, username)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        spreadsheet.add_new_buyer(
            sheet_name=BUYERS_SHEET_NAME,
            username=username,
            nm_id=nm_id
        )
        # –ª–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        logging.info(
            f"–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç (@{username}, {full_name}), id={user_id}: {text} ..."
        )
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é + –∫–Ω–æ–ø–∫–∏
        await message.answer(
            instruction_str,
            parse_mode="MarkdownV2",
            reply_markup=get_three_buttons_keyboard()
        )
    
    # —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ —è –∏ —Ç–µ–º–∞
    elif user_id in ADMIN_ID_LIST:
        
        # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        spreadsheet.update_buyer_last_time_message(
            sheet_name=BUYERS_SHEET_NAME,
            username=username
        )
        # –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –µ—â—ë –Ω–µ –Ω–∞–∂–∞—Ç—ã 
        remaining_buttons = spreadsheet.get_remaining_buttons(
            sheet_name=BUYERS_SHEET_NAME, 
            username=username
        )
        # —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ–ª–∞–µ–º –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä —É —Å–æ–æ–±—â–µ–Ω–∏—è
        text = message.text.strip().lower()   
        pattern = r"#–≤—ã–ø–ª–∞—Ç–∞_\d{1,2}_[–∞-—è–ê-–Ø—ë–Å]+"
        if "?" in text: 
            # –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è(–ø–æ–∫–∞ –æ—Ç–≤–µ—Ç –æ—Ç –≥–ø—Ç –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª—Å—è)
            await state.set_state('generating')
            try: 
                response = create_response(text, instruction_str)
            except Exception as e:
                await message.answer(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
            else:
                # –µ—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –∫–Ω–æ–ø–∫–∏ –µ—â—ë –Ω–µ –Ω–∞–∂–∞–ª - —Ç–æ –∫ –æ—Ç–≤–µ—Ç—É –∏–∏ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è
                if remaining_buttons:                    
                    await message.answer(
                        response,
                        reply_markup=get_different_number_of_buttons_keyboard(remaining_buttons)
                    )
                else:
                    await message.answer(response)
            finally:
                await state.clear()
        else:
            if len(text) > LOWER_LIMIT_OF_MESSAGE_LENGTH:
                await state.set_state('generating')
                try: 
                    response = create_response(text, instruction_str)
                except Exception as e:
                    await message.answer(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
                else:
                    if remaining_buttons:  
                        await message.answer(
                            response,
                            reply_markup=get_different_number_of_buttons_keyboard(remaining_buttons)
                        )
                    else:
                        await message.answer(response)                
                finally:
                    await state.clear()
            elif text in OK_WORDS:
                await message.answer("üëç")
            elif re.fullmatch(pattern, text):
                # —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —à–∞–±–ª–æ–Ω–æ–º #–≤—ã–ø–ª–∞—Ç–∞_DD_MONTH
                await message.answer("–í–´–ü–õ–ê–¢–ê_–ü–†–ò–ù–ò–ú–ê–ï–¢–°–Ø")
                # –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞—Ç—É –∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤ Google Sheet
            elif "#" in text:
                await message.answer(
                    "‚ùå –í—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–∫–∞–∑–∞–ª–∏ –¥–∞—Ç—É –≤—ã–ø–ª–∞—Ç—ã. "
                    "–ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø–æ —à–∞–±–ª–æ–Ω—É, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤: #–≤—ã–ø–ª–∞—Ç–∞_DD_MONTH"
                )
            else:
                await message.answer("–ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à –≤–æ–ø—Ä–æ—Å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º")


# ==== –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ ====
@router.callback_query(F.data.startswith("feedback_"))
async def handle_feedback(
    callback: CallbackQuery,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str
):
    username = callback.from_user.username or "–±–µ–∑ username"
    value = "–î–∞" if callback.data == "feedback_yes" else "–ù–µ—Ç"
    
    # –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å "–û—Ç–∑—ã–≤ –æ—Å—Ç–∞–≤–ª–µ–Ω"
    spreadsheet.update_buyer_button_status(
        sheet_name=BUYERS_SHEET_NAME, 
        username=username, 
        button_name="feedback", 
        value=value
    )
    
    # –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
    remaining_buttons = spreadsheet.get_remaining_buttons(
        sheet_name=BUYERS_SHEET_NAME, 
        username=username
    )
    if remaining_buttons:
        await callback.message.answer(
            f"‚úÖ –í–∞—à –æ—Ç–≤–µ—Ç '{value}' –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.",
            reply_markup=get_different_number_of_buttons_keyboard(remaining_buttons)
        )
    else:
        await callback.message.answer("‚úÖ –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, —Å–ø–∞—Å–∏–±–æ!")

    await callback.answer()


@router.callback_query(F.data.startswith("order_"))
async def handle_order(
    callback: CallbackQuery,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str
):
    username = callback.from_user.username or "–±–µ–∑ username"
    value = "–î–∞" if callback.data == "order_yes" else "–ù–µ—Ç"
    
    # –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å "–ó–∞–∫–∞–∑ —Å–¥–µ–ª–∞–Ω"
    spreadsheet.update_buyer_button_status(
        sheet_name=BUYERS_SHEET_NAME, 
        username=username, 
        button_name="order", 
        value=value
    )
    
    # –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
    remaining_buttons = spreadsheet.get_remaining_buttons(
        sheet_name=BUYERS_SHEET_NAME, 
        username=username
    )
    if remaining_buttons:
        await callback.message.answer(
            f"‚úÖ –í–∞—à –æ—Ç–≤–µ—Ç '{value}' –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.",
            reply_markup=get_different_number_of_buttons_keyboard(remaining_buttons)
        )
    else:
        await callback.message.answer("‚úÖ –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, —Å–ø–∞—Å–∏–±–æ!")

    await callback.answer()


@router.callback_query(F.data.startswith("shk_"))
async def handle_shk(
    callback: CallbackQuery,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str
):
    username = callback.from_user.username or "–±–µ–∑ username"
    value = "–î–∞" if callback.data == "shk_yes" else "–ù–µ—Ç"
    
    # –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å "–®–ö —Ä–∞–∑—Ä–µ–∑–∞–Ω"
    spreadsheet.update_buyer_button_status(
        sheet_name=BUYERS_SHEET_NAME, 
        username=username, 
        button_name="shk", 
        value=value
    )
    
    # –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
    remaining_buttons = spreadsheet.get_remaining_buttons(
        sheet_name=BUYERS_SHEET_NAME, 
        username=username
    )
    if remaining_buttons:
        await callback.message.answer(
            f"‚úÖ –í–∞—à –æ—Ç–≤–µ—Ç '{value}' –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.",
            reply_markup=get_different_number_of_buttons_keyboard(remaining_buttons)
        )
    else:
        await callback.message.answer("‚úÖ –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, —Å–ø–∞—Å–∏–±–æ!")
    await callback.answer()
