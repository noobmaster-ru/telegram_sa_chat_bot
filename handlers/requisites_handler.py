from aiogram import Router, F
from aiogram.types import Message
import re
from google_sheets.google_sheets_class import GoogleSheetClass

router = Router()


# –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 4 –≥—Ä—É–ø–ø—ã –ø–æ 4 —Ü–∏—Ñ—Ä—ã, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø—Ä–æ–±–µ–ª –∏–ª–∏ –¥–µ—Ñ–∏—Å –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω.
card_pattern = r"(\d{4}(?:[ -]?\d{4}){3})"


# –°—É–º–º–∞: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—É—Ñ—Ñ–∏–∫—Å —Ä/—Ä—É–±/—Ä—É–±–ª–µ–π, –¥–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–±–µ–ª –ø–µ—Ä–µ–¥ —Å—É—Ñ—Ñ–∏–∫—Å–æ–º
amount_pattern = r"(\d+\s?(?:—Ä|—Ä—É–±|—Ä—É–±–ª–µ–π|‚ÇΩ|–†|–†—É–±–ª–µ–π))"

# –¢–µ–ª–µ—Ñ–æ–Ω: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä 9‚Äì11, –≤–æ–∑–º–æ–∂–Ω–æ —Å +7 –∏–ª–∏ 8 –≤ –Ω–∞—á–∞–ª–µ
phone_pattern = r"(\+7\d{8,10}|8\d{8,10}|\d{9,11})"

# --- –ù–æ–≤—ã–π —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤:  —Ö–æ—Ç—è –±—ã 2 —Ü–∏—Ñ—Ä—ã –∏–ª–∏ + –∏–ª–∏ –†—É–±/‚ÇΩ ---
@router.business_message(
    F.text.regexp(r"(?:(?:.*\d){2,}.*|\+.*|.*(?:—Ä—É–±|‚ÇΩ).*?)", flags=re.IGNORECASE)
)
async def handle_requisites_message(
    message: Message,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str,
    ADMIN_ID_LIST: list
):
    """
    –õ–æ–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏:
    - —Å–æ–¥–µ—Ä–∂–∞—Ç —Ü–∏—Ñ—Ä—ã
    - –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å '—Ä—É–±', '‚ÇΩ', '+', '–†—É–±', '—Ä—É–±–ª–µ–π'
    """
    telegram_id = message.from_user.id
    username = message.from_user.username or "–±–µ–∑ username"
    full_name = message.from_user.full_name or "–±–µ–∑ full_name"
    text = message.text.strip() if message.text else "(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)"

    # —Ç–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –º—ã —Å —Ç–µ–º–æ–π
    if telegram_id in ADMIN_ID_LIST:
        # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        spreadsheet.update_buyer_last_time_message(
            sheet_name=BUYERS_SHEET_NAME,
            username=username
        )
        
        card_match = re.search(card_pattern, text)
        amount_match = re.search(amount_pattern, text)
        phone_match = re.search(phone_pattern, text)
        
        card_number = card_match.group(1) if card_match else None
        amount = amount_match.group(1) if amount_match else None
        phone_number = phone_match.group(1) if phone_match else None
        # # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ —É–¥–æ–±–Ω–æ–º—É –≤–∏–¥—É
        # clean_text = re.sub(r"\s+", " ", text)
        # text_only_with_numbers = clean_text.split(" ")

        # list_only_numbers = [elem for elem in text_only_with_numbers if re.search(r'\d', elem)]
        await message.answer(f"üì© –ü–æ–ª—É—á–µ–Ω—ã —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:\n–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: `{phone_number}`\n–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: `{card_number}`\n–°—É–º–º–∞: `{amount}`", parse_mode="Markdown")

        if card_number:
            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç - —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
            spreadsheet.update_buyer_button_status(
                sheet_name=BUYERS_SHEET_NAME,
                username=username,
                button_name="requisites",
                value=card_number
            )
        if amount:
            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç - —Å—É–º–º–∞ –≤—ã–ø–ª–∞—Ç—ã
            spreadsheet.update_buyer_button_status(
                sheet_name=BUYERS_SHEET_NAME,
                username=username,
                button_name="amount",
                value=amount
            )
        if phone_number:
            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç - —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
            spreadsheet.update_buyer_button_status(
                sheet_name=BUYERS_SHEET_NAME,
                username=username,
                button_name="requisites",
                value=phone_number
            )