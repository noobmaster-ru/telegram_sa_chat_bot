from handlers.states.user_flow import UserFlow
from aiogram.fsm.context import FSMContext
from aiogram.filters import StateFilter
from aiogram import Router, types

from handlers.states.user_flow import UserFlow
from google_sheets.google_sheets_class import GoogleSheetClass

from handlers.keyboards.get_agreement_keyboard import get_agreement_keyboard
from handlers.keyboards.get_yes_no_keyboard import get_yes_no_keyboard
from handlers.keyboards.get_subscription_check_keyboard import get_subscription_check_keyboard



# –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—à–µ—Ç —Ç–µ–∫—Å—Ç,
# –ø–æ–∫–∞ –±–æ—Ç –∂–¥—ë—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –ª—é–±–æ–º –∏–∑ –∑–∞–¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π.
router = Router()


# @router.business_message(
#     StateFilter(
#         UserFlow.waiting_for_agreement,
#         UserFlow.waiting_for_order,
#         UserFlow.waiting_for_order_receive,
#         UserFlow.waiting_for_feedback,
#         UserFlow.waiting_for_shk,
#     )
# )
# async def handle_unexpected_text(
#     message: types.Message,
#     spreadsheet: GoogleSheetClass,
#     BUYERS_SHEET_NAME: str
# ):
#     telegram_id = message.from_user.id
#     # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
#     spreadsheet.update_buyer_last_time_message(
#         sheet_name=BUYERS_SHEET_NAME,
#         telegram_id=telegram_id
#     )
#     await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞.")


# --- 1. –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ —É—Å–ª–æ–≤–∏—è ---
@router.business_message(StateFilter(UserFlow.waiting_for_agreement))
async def handle_unexpected_text_waiting_for_agreement(
    message: types.Message,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str
):
    telegram_id = message.from_user.id
    # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    spreadsheet.update_buyer_last_time_message(
        sheet_name=BUYERS_SHEET_NAME,
        telegram_id=telegram_id
    )
    await message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –í—ã —Å–æ–≥–ª–∞—Å–Ω—ã –Ω–∞ —É—Å–ª–æ–≤–∏—è?",
        reply_markup=get_agreement_keyboard()
    )

# --- 2. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª ---
@router.business_message(StateFilter(UserFlow.waiting_for_subcription_to_channel))
async def handle_unexpected_text_waiting_for_subcription_to_channel(
    message: types.Message,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str,
    CHANNEL_USERNAME: str
):
    telegram_id = message.from_user.id
    # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    spreadsheet.update_buyer_last_time_message(
        sheet_name=BUYERS_SHEET_NAME,
        telegram_id=telegram_id
    )
    await message.answer(
        "‚ùå –ü–æ–∫–∞ –≤—ã –Ω–µ –ø–æ–¥–ø–∏—à–µ—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª ‚Äî —Ä–∞–∑–¥–∞—á–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.\n"
        f"–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ {CHANNEL_USERNAME} –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:",
        reply_markup=get_subscription_check_keyboard()
    )

# --- 3. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ ---
@router.business_message(StateFilter(UserFlow.waiting_for_order))
async def handle_unexpected_text_waiting_for_order(
    message: types.Message,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str
):
    telegram_id = message.from_user.id
    # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    spreadsheet.update_buyer_last_time_message(
        sheet_name=BUYERS_SHEET_NAME,
        telegram_id=telegram_id
    )
    await message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –í—ã –∑–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä? üì¶",
        reply_markup=get_yes_no_keyboard("order")
    )

# --- 4. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ ---
@router.business_message(StateFilter(UserFlow.waiting_for_order_receive))
async def handle_unexpected_text_waiting_for_order_receive(
    message: types.Message,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str
):
    telegram_id = message.from_user.id
    # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    spreadsheet.update_buyer_last_time_message(
        sheet_name=BUYERS_SHEET_NAME,
        telegram_id=telegram_id
    )
    await message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –í—ã –ø–æ–ª—É—á–∏–ª–∏ —Ç–æ–≤–∞—Ä? üì¨",
        reply_markup=get_yes_no_keyboard("receive")
    )


# --- 5. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ ---
@router.business_message(StateFilter(UserFlow.waiting_for_feedback))
async def handle_unexpected_text_waiting_for_feedback_done(
    message: types.Message,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str
):
    telegram_id = message.from_user.id
    # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    spreadsheet.update_buyer_last_time_message(
        sheet_name=BUYERS_SHEET_NAME,
        telegram_id=telegram_id
    )
    await message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –í—ã –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤? üí¨",
        reply_markup=get_yes_no_keyboard("feedback")
    )



# --- 6. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–∑—Ä–µ–∑–∞–Ω–Ω—ã—Ö –®–ö ---
@router.business_message(StateFilter(UserFlow.waiting_for_shk))
async def handle_unexpected_text_waiting_for_shk(
    message: types.Message,
    spreadsheet: GoogleSheetClass,
    BUYERS_SHEET_NAME: str
):
    telegram_id = message.from_user.id
    # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    spreadsheet.update_buyer_last_time_message(
        sheet_name=BUYERS_SHEET_NAME,
        telegram_id=telegram_id
    )
    await message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –í—ã —Ä–∞–∑—Ä–µ–∑–∞–ª–∏ –®–ö? ‚úÇÔ∏è",
        reply_markup=get_yes_no_keyboard("shk")
    )