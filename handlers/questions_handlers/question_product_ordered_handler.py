from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State

from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram import Router, F

from google_sheets.google_sheets_class import GoogleSheetClass


from handlers.keyboards.get_yes_no_keyboard import get_yes_no_keyboard

from handlers.states.user_flow import UserFlow

router = Router()

# questions = [
#     ("order", "üì¶ –í—ã –∑–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä?"),
#     ("receive", "üì¨ –í—ã –ø–æ–ª—É—á–∏–ª–∏ —Ç–æ–≤–∞—Ä?"),
#     ("feedback", "üí¨ –í—ã –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤?"),
#     ("shk", "‚úÇÔ∏è –®–ö —Ä–∞–∑—Ä–µ–∑–∞–ª–∏?")
# ]

from handlers.questions_handlers.questiong_order_receive_handler import ask_is_product_receive_question

async def ask_is_product_ordered_question(
    message: Message, 
    spreadsheet: GoogleSheetClass, 
    BUYERS_SHEET_NAME: str, 
    state: FSMContext
):
    await message.answer(
        "üì¶ –í—ã –∑–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä?", 
        reply_markup=get_yes_no_keyboard("order")
    )
    # –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ "üì¶ –í—ã –∑–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä?"
    await state.set_state(UserFlow.waiting_for_order)

# –Æ–∑–µ—Ä –ø–æ—Å–ª–µ "üì¶ –í—ã –∑–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä?" –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É –∫–∞–∫—É—é-—Ç–æ
@router.callback_query(F.data.startswith("order_"))
async def handle_question_answer(
    callback: CallbackQuery, 
    spreadsheet: GoogleSheetClass, 
    BUYERS_SHEET_NAME: str,
    state: FSMContext
):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ –î–∞/–ù–µ—Ç"""
    username = callback.from_user.username or "–±–µ–∑ username"
    telegram_id = callback.from_user.id
    data = callback.data

    key = data.split("_")[0]
    value = "–î–∞" if data.endswith("_yes") else "–ù–µ—Ç"

    # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –≥—É–≥–ª-—Ç–∞–±–ª–∏—Ü—É
    spreadsheet.update_buyer_button_status(
        sheet_name=BUYERS_SHEET_NAME,
        telegram_id=telegram_id,
        button_name=key,
        value=value
    )

    # –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç "–ù–µ—Ç" ‚Üí –∑–∞–¥–∞—ë–º —Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å –µ—â—ë —Ä–∞–∑
    if value == "–ù–µ—Ç":
        await callback.message.answer(
            "üì¶ –í—ã –∑–∞–∫–∞–∑–∞–ª–∏ —Ç–æ–≤–∞—Ä?",
            reply_markup=get_yes_no_keyboard("order")
        )
        await state.set_state(UserFlow.waiting_for_order)
        await callback.answer()
        return

    # –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç "–î–∞" ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
    await ask_is_product_receive_question(callback.message, spreadsheet, BUYERS_SHEET_NAME, state)
    await callback.answer()