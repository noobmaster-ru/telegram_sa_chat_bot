from aiogram import Router
from aiogram.types import Message
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext

from database import user_exists, add_user, get_user_count
import logging

from generators import create_response

router = Router()

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[
        logging.FileHandler("data/bot.log", encoding="utf-8"),  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
        logging.StreamHandler(),  # –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
    ],
)

ADMIN_ID_LIST = [694144143, 547299317]

@router.business_message(Command("stats"))
async def cmd_stats(message: Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É)"""
    if message.from_user.id not in ADMIN_ID_LIST:
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    count = get_user_count()
    await message.answer(f"üìä –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞–ø–∏—Å–∞–ª–æ: *{count}*", parse_mode="MarkdownV2")


@router.message(StateFilter("generating"))
async def wait_response(message: Message):
    await message.answer("–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞, –∏–¥—ë—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞....")

# –∑–¥–µ—Å—å –Ω–∞–¥–æ –±—ã–ª–æ business_message —É–∫–∞–∑–∞—Ç—å!!!!!
@router.business_message()
async def handle_message(message: Message, state: FSMContext, nm_id: str):
    user_id = message.from_user.id
    username = message.from_user.username or "–±–µ–∑ username"
    full_name = message.from_user.full_name or "–±–µ–∑ full_name"
    text = message.text if message.text else "(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)"


    # —Ç–µ—Å—Ç - –æ—Ç–≤–µ—á–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —è –∏ —Ç–µ–º–∞
    if user_id in ADMIN_ID_LIST and not user_exists(user_id):
        add_user(user_id, username)

        # –ª–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        logging.info(
            f"–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç (@{username}, full_name), id={user_id}: {text} ..."
        )
        WELCOME_TEXT = (
            "*–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ\!*\n\n"
            "*–ü—Ä–∞–≤–∏–ª–∞ –≤—ã–∫—É–ø–∞*\n"
            f"1\\. –î–ª—è –∑–∞–∫–∞–∑–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–±–∏—Ç—å –≤ –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É: `{nm_id}`\n"
            "2\\. –ü—Ä–∏—Å–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç —Å–¥–µ–ª–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞\n"
            "3\\. –ó–∞–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤ –ü–í–ó\n\n"

            "*–ü—Ä–∞–≤–∏–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–∞* \\(–∑–∞ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∏–∑ –ø—É–Ω–∫—Ç–æ–≤ *–í–´–ü–õ–ê–¢–´ –ù–ï –ë–£–î–ï–¢*\\):\n"
            "0\\. –ù–µ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –≤–∏–¥–µ–æ –∫ –æ—Ç–∑—ã–≤—É\n"
            "1\\. –û—Å—Ç–∞–≤–∏—Ç—å *5 –∑–≤–µ–∑–¥* *—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è*\n"
            "2\\. –¢–µ–∫—Å—Ç –æ–±—â–∏–π —Ñ–æ—Ä–º–∞—Ç: \"–≤—Å–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å\", \"–∫–∞—á–µ—Å—Ç–≤–æ —Ö–æ—Ä–æ—à–µ–µ\"\n"
            "3\\. –†–∞–∑—Ä–µ–∑–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏\n\n"

            "*–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã:*\n"
            "0\\. –ü—Ä–∏—Å–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–∑—ã–≤–∞, —Ä–∞–∑—Ä–µ–∑–∞–Ω–Ω—ã–µ —ç—Ç–∏–∫–µ—Ç–∫–∏, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –±–∞–Ω–∫ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞\n"
            "1\\. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ: `#–≤—ã–ø–ª–∞—Ç–∞_29_—Å–µ–Ω—Ç—è–±—Ä—è`, –Ω–æ —Å –≤–∞—à–µ–π –¥–∞—Ç–æ–π\n"
            "2\\. –í—ã–ø–ª–∞—Ç–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–∞\n\n"

            "*–í–ê–ñ–ù–û:*\n"
            "> –í–æ –≤—Ä–µ–º—è –í–°–ï–ì–û –ü–†–û–¶–ï–°–°–ê –ú–´ –ù–ï –ë–£–î–ï–ú –ß–ò–¢–ê–¢–¨ –ò –û–¢–í–ï–ß–ê–¢–¨ –í–ê–ú\\.\n"
            "> –ü–æ—Å–ª–µ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å `#–≤—ã–ø–ª–∞—Ç–∞_–¥–µ–Ω—å_–º–µ—Å—è—Ü` –º—ã –ø—Ä–æ–≤–µ—Ä–∏–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å—Ä–∞–∑—É –∂–µ –æ—Ç–ø—Ä–∞–≤–∏–º –ø–ª–∞—Ç–µ–∂\\.\n"
            "> –ü—Ä–∏ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π –º—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º –ø–ª–∞—Ç–µ–∂, –ø–æ–∫–∞ –Ω–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ —É—Å–ª–æ–≤–∏—è\\.\n\n"

            "*–û—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã:*\n"
            "‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ, –ø–æ–∫–∞ —Ç–æ–≤–∞—Ä –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ –í–ë\n"
            "‚Ä¢ –û—Ç–∑—ã–≤–æ–≤ –Ω–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –Ω–∞—á–∞–ª–∏ –¥–µ–ª–∞—Ç—å —Ä–∞–∑–¥–∞—á–∏\n"
            "‚Ä¢ –ë–µ–∑ `#–≤—ã–ø–ª–∞—Ç–∞_–¥–µ–Ω—å_–º–µ—Å—è—Ü` ‚Äî –≤—ã–ø–ª–∞—Ç—ã –Ω–µ –±—É–¥–µ—Ç"
        )

        await message.answer(WELCOME_TEXT, parse_mode="MarkdownV2")
    
    # —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ —è –∏ —Ç–µ–º–∞
    elif user_id in ADMIN_ID_LIST:
        # –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è(–ø–æ–∫–∞ –æ—Ç–≤–µ—Ç –æ—Ç –≥–ø—Ç –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª—Å—è)
        await state.set_state('generating')

        try: 
            response = create_response(text)
        except Exception as e:
            await message.answer(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        else:
            await message.answer(response)
        finally:
            await state.clear()
